<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="~/Content/img/ico.png">
    <title>@ViewBag.Title</title>
    <!--CSS -->
    @RenderSection("styles", required: false)

    @Styles.Render("~/Content/styles")
    @Styles.Render("~/Content/css/core.css")
    @Styles.Render("~/Content/css/components.css")
    @Styles.Render("~/Content/css/icons.css")
    @Styles.Render("~/Content/css/pages.css")
    @Styles.Render("~/Content/css/menu.css")
    @Styles.Render("~/Content/css/responsive.css")
    @Styles.Render("~/Content/css/style.css")
    @Styles.Render("~/Content/Loading.css")
    @Styles.Render("~/Content/plugins/jquery-datatables-editable/datatables.css")
    @Styles.Render("~/Content/plugins/custombox/dist/css/custombox.min.css")
    @Styles.Render("~/Content/plugins/switchery/dist/switchery.min.css")
    @Styles.Render("~/Content/plugins/animate.less/animate.min.css")
    <link href="~/Content/plugins/datatables/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/mCustomScrollbar/jquery.mCustomScrollbar.css" rel="stylesheet" />
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/bootstrapjs")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/Content/plugins/switchery/dist/switchery.min.js")

</head>
<body class="fixed-left">
    @{
        string[] userName = Membership.GetUser(User.Identity.Name).UserName.Split();
    }
    <div id="wrapper">
        <header id="topnav">
            <div class="topbar-main">
                <div class="topbar-left">
                    <a href="/" class="logo">
                        <img src="~/Content/images/gerb.png" alt="Герб">
                        <span>Министерство природных ресурсов и экологии РД</span>
                    </a>
                </div>
                <div class="content-page">
                    <div class="container">
                        <div class="menu-extras clearfix">
                            <ul class="nav navbar-nav navbar-left pull-left hidden-xs">
                                <li class="dropdown navbar-c-items">
                                    <form role="search" class="navbar-left app-search pull-left" onsubmit="$('#searchBtn.dropdown-toggle').dropdown('toggle'); return false;">
                                        <input type="text" id="searchText" autocomplete="off" class="form-control" placeholder="Поиск обращения...">

                                        <div class="dropdown search-params">
                                            <a href="#" id="btnSearchSettings" data-toggle="dropdown" data-toor-name="search-settings" class="dropdown-toggle"><i class="ion-ios7-settings-strong"></i></a>
                                            <div id="searchSettingsPanel" class="dropdown-menu">
                                                <h3 class="panel-title m-l-15">Настройки поиска</h3>
                                                <hr class="m-t-5 m-b-10" />
                                                <div class="form-group m-l-5">
                                                    <div class="col-sm-12 form-group">
                                                        <fieldset class="fa-border p-10" style="padding:10px">
                                                            <legend style="width: 50%; margin-bottom: 0px; font-size: 18px; border:none;">
                                                                Что ищем?
                                                            </legend>
                                                            <label class="js-switch extra-small"> <input type="radio" name="radioSearchType" value="SearchServiceCustomer" checked /> Обращение</label>  <br />
                                                            <label class="js-switch extra-small"> <input type="radio" name="radioSearchType" value="SearchCustomer" /> Физическое лицо</label> <br />


                                                        </fieldset>

                                                    </div>
                                                    <div class="col-sm-12">
                                                        <input id="switchNewTab" class="js-switch extra-small" type="checkbox" data-switchery="true" data-plugin="switchery" data-color="#5d9cec" /><label class="m-l-10" for="switchNewTab" style="cursor: pointer">Открыть в новой вкладке</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="dropdown search-params search-btn">
                                            <a href="#" id="searchBtn" data-toggle="dropdown" class="dropdown-toggle"><i class="ion-ios7-search-strong"></i></a>
                                            <div id="searchPanel" class="dropdown-menu p-0">
                                                <div style="padding: 10px; width: 500px;" id="searchPanelContainer">

                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </li>
                            </ul>
                            <ul class="nav navbar-nav navbar-right pull-right p-t-10 p-b-10">

                                

                                <li class="dropdown">
                                    <a href="#" class="waves-effect waves-light" id="epguBarBtn" data-target="#epguBar" data-toggle="animation" data-animation="slideInRight">
                                        <i class="ion ion-clock"></i> <span class="badge badge-xs badge-danger"></span>
                                    </a>
                                </li>
                                <li class="dropdown">
                                    <a href="#" class="waves-effect waves-light" id="alertBtn" data-target="#alertBar" data-toggle="animation" data-animation="slideInRight">
                                        <i class="icon-bell"></i> <span class="badge badge-xs badge-danger"></span>
                                    </a>
                                </li>
                                
                                
                                    <li>
                                        <a data-toor-name="settings" href="" class="dropdown-toggle waves-effect waves-light" data-toggle="dropdown"><i class="icon-settings"></i></a>
                                        <ul class="dropdown-menu">
                                            <li class="">
                                                <a href="@Url.Action("Settings", "System")">
                                                    <i class="fa fa-gear"></i>
                                                    Настройки
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="@Url.Action("Errors", "System")">
                                                    <i class="fa fa-warning"></i>
                                                    Ошибки
                                                </a>
                                            </li>
                                            <li class="">
                                                <a href="@Url.Action("ChangeLogs", "System")">
                                                    <i class="fa fa-edit"></i>
                                                    История изменений
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                
                                <li class="dropdown navbar-c-items">
                                    <a href="" class="dropdown-toggle waves-effect waves-light profile" data-toggle="dropdown" aria-expanded="true">
                                        <div style="display: inline-block;">
                                            <img src="~/Content/images/ava4.png" alt="user-img" class="img-circle" style="height: 20px; width: 20px;">
                                        </div>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <div class="text-nowrap" style="padding: 0 10px;">
                                                <span>@((userName.Count() >= 2) ? userName[1] + " " + userName[0] : userName[0])</span>
                                            </div>
                                        </li>
                                        <li>
                                            @using (Ajax.BeginForm("ChangePassword", "Home", new { User.Identity.Name }, new AjaxOptions { UpdateTargetId = "myModal", OnSuccess = "$('#myModal').modal('show');" }))
                                            {
                                                <button type="submit" style="width:200px;"><i class="fa fa-key m-r-5"></i>Сменить пароль</button>
                                            }
                                        </li>
                                        <li><a href="@Url.Action("LogOff", "Account")"><i class="ti-power-off m-r-5"></i> Выйти</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </header>
        
        <div id="epguBar" class="fixed-bar animated" style="display: none;">
            <header class="fixbar-header">
                <h5 class="text-dark">Дата и время обращения с портала ЕПГУ</h5>
                <div class="alert-sort-btn">
                </div>
                <button class="close" data-target="#barEPGU" data-toggle="animation" data-animation="slideInRight" onclick="$('#epguBarBtn').click();">
                    <i class="ion ion-ios7-close-empty"></i>
                </button>
            </header>
            <div id="epguBarContainer">
            </div>
        </div>
        

        <div id="alertBar" class="fixed-bar animated" style="display: none;">
            <header class="fixbar-header">
                <h5 class="text-custom">Уведомления</h5>
                <div class="alert-sort-btn">
                    <button class="sort-btn active sort" data-sort="all">
                        <span>Все</span>
                    </button>
                    <button class="sort-btn sort" data-sort="comment">
                        <i class="ion ion-ios7-email"></i>
                    </button>
                    <button class="sort-btn" data-sort="reminder">
                        <i class="ion ion-ios7-bell"></i>
                    </button>
                    <button class="sort-btn" data-sort="newService">
                        <i class="ion ion-ios7-filing"></i>
                    </button>
                    <button class="sort-btn" data-sort="smev">
                        <i class="ion ion-ios7-world"></i>
                    </button>
                </div>
                <button class="close" data-target="#barAlert" data-toggle="animation" data-animation="slideInRight" onclick="$('#alertBtn').click();">
                    <i class="ion ion-ios7-close-empty"></i>
                </button>
                
            </header>
            <div id="alertBarContainer">
            </div>
        </div>
        <div class="left side-menu">
            <div class="sidebar-inner slimscrollleft">
                <div id="sidebar-menu">
                    @Html.MvcSiteMap().Menu()
                    <div class="clearfix"></div>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        <div class="content-page">
            <div class="content">
                <div class="container">
                    @RenderBody()
                </div>
            </div>
            <footer class="footer">
                © 2025 «WebSystems»
            </footer>
        </div>
    </div>

    <script>
        $(function () {
            $.ajax({
                async: false,
                url: '@Url.Action("PartialListEmployeeAlerts", "Home")',
                type: 'GET',
                success: function (data) {
                    $("#alertBarContainer").html(data);
                }
            });

            $.ajax({
                async: false,
                url: '@Url.Action("PartialListEPGUCustomers", "EPGU")',
                type: 'GET',
                success: function (data) {
                    $("#epguBarContainer").html(data);
                }
            });

            var options = {
                valueNames: [{ data: ['type'] }]
            };

            var userList = new List('alertBarContainer', options);
            $('[data-sort]').click(function () {
                $(this).siblings().removeClass('active');
                $(this).addClass('active');
                var filter = $(this).data('sort');
                userList.filter(function (item) {
                    if (item.values().type === filter || filter === 'all') {
                        return true;
                    } else {
                        return false;
                    }
                });
            });
            userList.on('filterComplete', function () {
                if (userList.visibleItems.length === 0) {
                    $('#alertBarContainer ul.alert-list').html('<li data-type="isEmpty"><div class="alert alert-warning"><span style="color:#00545c;"><strong><i class="icon-info"></i></strong> Нет данных.</span></div></li>');
                }
            });
            if (localStorage.getItem('switchNewTab') === 'true') { // если значение ключа hide "inline"
                $('#switchNewTab').trigger('click');
            }

            $("#switchNewTab").on('change', function () {
                localStorage.setItem('switchNewTab', document.querySelector('#switchNewTab').checked);
            });
        });
        $("input[name='radioSearchType']").click(function () {
            
            if ($("input[name='radioSearchType']:checked").val() === 'SearchCustomer') {
                $("#searchText").attr("placeholder", "Поиск физ. лица...");
            } else {
                $("#searchText").attr("placeholder", "Поиск обращения...");
            }
        });
        $(document).on('click', '#searchPanelContainer tr', function () {
            var url = '';
            
            if ($("input[name='radioSearchType']:checked").val() === 'SearchCustomer') {
                var customerId = $(this).data('id');
                url = '/ApplicantPage/Main#' + customerId;
            } else {
                var infoId = $(this).data('id');
                url = '/Case/Main/' + infoId;
            }

            console.log(url);
            if (document.querySelector('#switchNewTab').checked) {
            window.open(url,'_blank');
            }
            else {
                location.href = url;
            }
        });

        $("#searchText").focus(function () {
            $('.dropdown.open').removeClass('open');
        });


        $(".dropdown.search-btn").on("show.bs.dropdown", function () {
            var searchText = $('#searchText').val();
            if (searchText.length > 1) {
                $('#searchPanelContainer').html('<span>Идет поиск, пожалуйста подождите</span>\
                                             <div id="fountainG" class="m-t-5"><div id="fountainG_1" class="fountainG"></div><div id="fountainG_2" class="fountainG"></div><div id="fountainG_3" class="fountainG"></div><div id="fountainG_4" class="fountainG"></div><div id="fountainG_5" class="fountainG"></div><div id="fountainG_6" class="fountainG"></div><div id="fountainG_7" class="fountainG"></div><div id="fountainG_8" class="fountainG"></div></div>');
                $.ajax({
                    url: '@Url.Action("Search", "Home")',
                    type: 'GET',
                    data: { searchType: $("input:radio[name='radioSearchType']:checked").val(), searchText: searchText },
                    success: function (data) {
                            
                        if (data.length > 0) {
                            var resultList = '<b>Результат поиска</b><hr class="m-t-5"><div class="slimscroll-search" style="height: 550px;"> <table class="table table-hover"><tbody>'
                            if ($("input[name='radioSearchType']:checked").val() === 'SearchCustomer') {
                                data.forEach(function (e) {
                                    resultList += `<tr data-id="${e.id}">
                                    <td class="vertical-middle">
                                    <span class="font-600">${e.customer_name}</span><br />
                                    ${e.actual_address} <br />

                                    </td>
                                    </tr>`
                                });
                            }
                            else {
                                data.forEach(function (e) {
                                    resultList += `<tr data-id="${e.data_services_info_id}">
                                    <td class="vertical-middle">
                                    <span class="font-600">${e.customer_fio}</span><br />
                                    ${e.spr_services_sub_name} <br />
                                    <span>#${e.data_services_info_id}</span> от <span> ${moment(e.set_date).format("DD.MM.YYYY")} </span> <span class="label label-danger">Просрочено</span><br /><br />
                                    </td>
                                    </tr>`
                                });
                            }

                            resultList += '</tbody></table></div>';
                            $('#searchPanelContainer').html(resultList);
                            $('.slimscroll-search').slimScroll({
                                height: '100%',
                                position: 'right',
                                size: "5px",
                                color: '#98a6ad',
                                wheelStep: 20
                            });
                            $('.slimScrollDiv').css('max-height', '550px');
                            $('.slimscroll-search').css('max-height', '550px');
                        } else {
                            console.log('Нет данных');
                            $('#searchPanelContainer').html('Нет данных');
                        }
                    }
                });
            } else {
                $('#searchPanelContainer').html('<span class="text-danger text-nowrap"><b>Строка поиска должна содержать более 1-го символа!</b></span>');
            }
        });

        // unblock when ajax activity stops
        $(document).ajaxStart(function () {
            $.blockUI({ message: '<div class="fa fa-spin fa-spinner icon-lg"></div>', overlayCSS: { backgroundColor: "#FFF", cursor: "wait" }, css: { border: 0, padding: 0, backgroundColor: "none" } });
        }).ajaxStop(function () {
            $.unblockUI();
        });

        var resizefunc = [];
        $('.navbar-toggle').on('click', function (event) {
            $(this).toggleClass('open');
            $('#navigation').slideToggle(400);
            $('.cart, .search').removeClass('open');
        });

        $('.navigation-menu>li').slice(-1).addClass('last-elements');

        $('.navigation-menu li.has-submenu a[href="#"]').on('click', function (e) {
            if ($(window).width() < 992) {
                e.preventDefault();
                $(this).parent('li').toggleClass('open').find('.submenu:first').toggleClass('open');
            }
        });


        // событие клика по веб-документу
        $(document).mouseup(function (e) {

            var bar = $("#alertBar"); // Панель уведомлений
            var btn = $("#alertBtn"); // Кнопка уведомлений

            // Проверяем, находится ли курсор на панели или на кнопке уведомлений, если нет, то закрываем панель
            if (!bar.is(e.target)
                && bar.has(e.target).length === 0
                && !btn.is(e.target)
                && btn.has(e.target).length === 0) {
                bar.removeClass('slideInRight').addClass('slideOutRight');
                setTimeout(function () {
                    bar.hide().removeClass('slideOutRight');
                    btn.closest('li').removeClass('open');
                }, 200);
            }
            else {
                $('.navbar .active').removeClass('active');
                btn.closest('li').addClass('open');
            }

            var searchText = $('#searchText');
            var searchSettingsPanel = $('#searchSettingsPanel');
            var searchBtn = $('#searchBtn');

            if (!searchText.is(e.target)
                && searchText.has(e.target).length === 0
                && !searchBtn.is(e.target)
                && searchBtn.has(e.target).length === 0
                && !searchSettingsPanel.is(e.target)
                && searchSettingsPanel.has(e.target).length === 0) {
                    searchText.removeClass('focus');
            }
        });

        $(document).on('focus', '#searchText', function () {
            $(this).addClass('focus');
        });
        var checked = document.querySelectorAll('input:checked');

if (checked.length === 0) {
    // there are no checked checkboxes
    console.log('no checkboxes checked');
} else {
    // there are some checked checkboxes
    console.log(checked.length + ' checkboxes checked');
}

        $(document).on('click', '#btnSearchSettings', function () {
            $('#searchText').addClass('focus');
        });

        $(document).on('click', '[data-toggle="animation"]', function (event) {
            //event.stopPropagation();
            var button = $(this);
            var target = $(button.data('target'));
            var animationIn = button.data('animation');
            var animationOut = animationIn.replace('In', 'Out').replace('Up', 'Down').replace('Down', 'Up');
            var state = target.hasClass(animationIn);
            if (state) {
                target.removeClass(animationIn).addClass(animationOut);
                setTimeout(function () {
                    target.hide().removeClass(animationOut);
                    button.closest('li').removeClass('open');
                }, 200);
            } else {
                target.addClass(animationIn).show();
                button.closest('li').addClass('open');
            }
        });
        $(document).on('show.bs.modal', '#secondaryModal', function (e) {
            $("#myModal .modal-dialog").block({ message: '<div class="icon-spinner9 icon-spin icon-lg"></div>', overlayCSS: { backgroundColor: "#000", cursor: "wait", opacity: ".3" }, css: { border: 0, padding: 0, backgroundColor: "none" } });
        });
        $(document).on('hidden.bs.modal', '#secondaryModal', function (e) {
            $("#myModal .modal-dialog").unblock();
        });

    </script>
    <!-- jQuery  -->
    @Scripts.Render("~/bundles/javaScripts")
    <script src="~/Content/js/detect.js"></script>
    <script src="~/Content/js/fastclick.js"></script>
    <script src="~/Content/js/jquery.slimscroll.js"></script>
    <script src="~/Content/js/jquery.blockUI.js"></script>
    <script src="~/Content/js/waves.js"></script>
    <script src="~/Content/js/wow.min.js"></script>
    <script src="~/Content/js/jquery.nicescroll.js"></script>
    <script src="~/Content/js/jquery.scrollTo.min.js"></script>
    <script src="~/Content/js/jquery.core.js"></script>
    <script src="~/Content/js/jquery.app.js"></script>
    <script src="~/Content/plugins/list/list.min.js"></script>
    <script src="~/Content/plugins/mCustomScrollbar/jquery.mCustomScrollbar.js"></script>
    <script src="~/Content/plugins/DataTables1.10.15/media/js/dataTables.bootstrap.min.js"></script>
    <div id="custom-modal" class="modal-demo">
    </div>
    <div id="myModal" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;" data-backdrop="static" data-keyboard="false">
    </div>
    <div id="secondaryModal" class="modal fade" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;" data-backdrop="false">
    </div>
    @RenderSection("scripts", required: false)
</body>
</html>
